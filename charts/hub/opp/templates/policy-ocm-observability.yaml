{{- $obc := (lookup "objectbucket.io/v1alpha1" "ObjectBucket" "" "openshift-storage-obc-observability") -}}
{{- $secret := (lookup "v1" "Secret" "openshift-storage" "noobaa-admin") -}}
{{- $bucketName := "obc-observability-bucket" -}}
{{- $endpoint := "s3.openshift-storage.svc.cluster.local" -}}
{{- $accessKey := "placeholder" -}}
{{- $secretKey := "placeholder" -}}
{{- if $obc -}}
{{- $bucketName = $obc.spec.endpoint.bucketName -}}
{{- $endpoint = $obc.spec.endpoint.bucketHost -}}
{{- end -}}
{{- if $secret -}}
{{- $accessKey = $secret.data.AWS_ACCESS_KEY_ID | b64dec -}}
{{- $secretKey = $secret.data.AWS_SECRET_ACCESS_KEY | b64dec -}}
{{- end -}}
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CA Assessment Authorization and
      Monitoring
    policy.open-cluster-management.io/controls: CA-7 Continuous Monitoring
    policy.open-cluster-management.io/standards: NIST SP 800-53
    argocd.argoproj.io/compare-options: IgnoreExtraneous
  labels:
    open-cluster-management.io/policy-set: openshift-plus
  name: policy-ocm-observability
  namespace: policies
spec:
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: policy-ocm-observability
        annotations:
          argocd.argoproj.io/compare-options: IgnoreExtraneous
      spec:
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: Secret
            metadata:
              name: thanos-object-storage
              namespace: open-cluster-management-observability
            type: Opaque
            stringData:
              thanos.yaml: |
                type: s3
                config:
                  bucket: "{{ $bucketName }}"
                  endpoint: "{{ $endpoint }}"
                  insecure: false
                  access_key: "{{ $accessKey }}"
                  secret_key: "{{ $secretKey }}"
                  http_config:
                    insecure_skip_verify: true
                    tls_config:
                      insecure_skip_verify: true
        - complianceType: musthave
          objectDefinition:
            apiVersion: observability.open-cluster-management.io/v1beta2
            kind: MultiClusterObservability
            metadata:
              name: observability
              namespace: open-cluster-management-observability
            spec:
              observabilityAddonSpec: {}
              storageConfig:
                metricObjectStorage:
                  key: thanos.yaml
                  name: thanos-object-storage
        remediationAction: enforce
        severity: medium
